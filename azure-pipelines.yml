
trigger: none   # manual runs only; change to - main if you want CI

pool:
  vmImage: 'ubuntu-latest'

# One variable group containing all secrets.
variables:
- group: WeatherStackSecrets

stages:
# =========================
# DEV
# =========================
- stage: DEV
  displayName: "DEV"
  dependsOn: []
  jobs:
  - deployment: Dev_DeployAndValidate
    displayName: "Dev: Build, Deploy & Validate API"
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: "Checkout repository"

          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: "Install Node.js 18.x"

          - script: npm install -g newman newman-reporter-htmlextra
            displayName: "Install Newman & reporters"

          - script: |
              set -e
              mkdir -p newman
              ENV_FILE="env/dev.postman_environment.json"
              [ -f "${ENV_FILE}" ] || { echo "Missing ${ENV_FILE}"; exit 3; }

              newman run collections/weatherstack.postman_collection.json \
                --environment "${ENV_FILE}" \
                --env-var access_key="$(WEATHERSTACK_KEY)" \
                --env-var api_key="$(DEV_API_KEY)" \
                --reporters cli,htmlextra,junit \
                --reporter-htmlextra-export "newman/dev-report.html" \
                --reporter-junit-export "newman/dev-results.xml"

              {
                echo "# WeatherStack API — DEV Validation"
                echo "- JUnit: newman/dev-results.xml"
                echo "- HTML: newman/dev-report.html"
              } > newman/dev-summary.md

              echo "##vso[task.uploadsummary]newman/dev-summary.md"
            displayName: "Execute API validation (DEV)"
            env:
              WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
              DEV_API_KEY: $(DEV_API_KEY)

          - task: PublishTestResults@2
            displayName: "Publish DEV test results"
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'newman/dev-results.xml'
              testRunTitle: 'WeatherStack API — DEV'
              failTaskOnFailedTests: false

          - task: PublishBuildArtifacts@1
            displayName: "Publish DEV HTML report"
            condition: always()
            inputs:
              PathtoPublish: 'newman'
              ArtifactName: 'NewmanReports'
              publishLocation: 'Container'

# =========================
# QA
# =========================
- stage: QA
  displayName: "QA"
  dependsOn: []
  jobs:
  - deployment: QA_DeployAndValidate
    displayName: "QA: Deploy & Validate API"
    environment: qa
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: "Checkout repository"

          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: "Install Node.js 18.x"

          - script: npm install -g newman newman-reporter-htmlextra
            displayName: "Install Newman & reporters"

          - script: |
              set -e
              mkdir -p newman
              ENV_FILE="env/qa.postman_environment.json"
              [ -f "${ENV_FILE}" ] || { echo "Missing ${ENV_FILE}"; exit 3; }

              newman run collections/weatherstack.postman_collection.json \
                --environment "${ENV_FILE}" \
                --env-var access_key="$(WEATHERSTACK_KEY)" \
                --env-var api_key="$(QA_API_KEY)" \
                --reporters cli,htmlextra,junit \
                --reporter-htmlextra-export "newman/qa-report.html" \
                --reporter-junit-export "newman/qa-results.xml"

              {
                echo "# WeatherStack API — QA Validation"
                echo "- JUnit: newman/qa-results.xml"
                echo "- HTML: newman/qa-report.html"
              } > newman/qa-summary.md

              echo "##vso[task.uploadsummary]newman/qa-summary.md"
            displayName: "Execute API validation (QA)"
            env:
              WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
              QA_API_KEY: $(QA_API_KEY)

          - task: PublishTestResults@2
            displayName: "Publish QA test results"
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'newman/qa-results.xml'
              testRunTitle: 'WeatherStack API — QA'
              failTaskOnFailedTests: false

          - task: PublishBuildArtifacts@1
            displayName: "Publish QA HTML report"
            condition: always()
            inputs:
              PathtoPublish: 'newman'
              ArtifactName: 'NewmanReports'
              publishLocation: 'Container'

# =========================
# UAT
# =========================
- stage: UAT
  displayName: "UAT"
  dependsOn: []
  jobs:
  - deployment: UAT_DeployAndValidate
    displayName: "UAT: Deploy & Validate API"
    environment: uat
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: "Checkout repository"

          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: "Install Node.js 18.x"

          - script: npm install -g newman newman-reporter-htmlextra
            displayName: "Install Newman & reporters"

          - script: |
              set -e
              mkdir -p newman
              ENV_FILE="env/uat.postman_environment.json"
              [ -f "${ENV_FILE}" ] || { echo "Missing ${ENV_FILE}"; exit 3; }

              newman run collections/weatherstack.postman_collection.json \
                --environment "${ENV_FILE}" \
                --env-var access_key="$(WEATHERSTACK_KEY)" \
                --env-var api_key="$(UAT_API_KEY)" \
                --reporters cli,htmlextra,junit \
                --reporter-htmlextra-export "newman/uat-report.html" \
                --reporter-junit-export "newman/uat-results.xml"

              {
                echo "# WeatherStack API — UAT Validation"
                echo "- JUnit: newman/uat-results.xml"
                echo "- HTML: newman/uat-report.html"
              } > newman/uat-summary.md

              echo "##vso[task.uploadsummary]newman/uat-summary.md"
            displayName: "Execute API validation (UAT)"
            env:
              WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
              UAT_API_KEY: $(UAT_API_KEY)

          - task: PublishTestResults@2
            displayName: "Publish UAT test results"
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'newman/uat-results.xml'
              testRunTitle: 'WeatherStack API — UAT'
              failTaskOnFailedTests: false

          - task: PublishBuildArtifacts@1
            displayName: "Publish UAT HTML report"
            condition: always()
            inputs:
              PathtoPublish: 'newman'
              ArtifactName: 'NewmanReports'
              publishLocation: 'Container'

# =========================
# PROD
# =========================
- stage: PROD
  displayName: "PROD"
  dependsOn: []
  jobs:
  - deployment: Prod_Deploy
    displayName: "Prod: Deploy"
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: "Checkout repository"

          - script: echo "Deploying to Production..."
            displayName: "Execute deployment (PROD)"
