
trigger: none   # manual runs only

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: WeatherStackSecrets

stages:
# -------------------------
# Dev (independent)
# -------------------------
- stage: Dev
  displayName: "Dev"
  dependsOn: []             # explicitly no dependency
  jobs:
  - deployment: DeployDev
    displayName: "Run tests & deploy — Dev"
    environment: dev        # remove if you don't use Environments/approvals
    strategy:
      runOnce:
        deploy:
          steps:
          - task: NodeTool@0
            inputs: { versionSpec: '18.x' }
            displayName: 'Install Node.js'
          - script: npm install -g newman newman-reporter-htmlextra
            displayName: 'Install Newman'
          - script: |
              set -e
              mkdir -p newman
              ENV_FILE="env/dev.postman_environment.json"
              [ -f "${ENV_FILE}" ] || { echo "Missing ${ENV_FILE}"; exit 3; }
              newman run collections/weatherstack.postman_collection.json \
                --environment "${ENV_FILE}" \
                --env-var access_key="$(WEATHERSTACK_KEY)" \
                --env-var api_key="$(DEV_API_KEY)" \
                --reporters cli,htmlextra,junit \
                --reporter-htmlextra-export "newman/dev-report.html" \
                --reporter-junit-export "newman/dev-results.xml"
            displayName: 'Run Newman (Dev)'
            env:
              WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
              DEV_API_KEY: $(DEV_API_KEY)
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'newman/dev-results.xml'
              testRunTitle: 'WeatherStack API — Dev'
            condition: always()
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'newman'
              ArtifactName: 'NewmanReports'
              publishLocation: 'Container'
            condition: always()

# -------------------------
# QA (independent)
# -------------------------
- stage: QA
  displayName: "QA"
  dependsOn: []             # make QA independent
  jobs:
  - deployment: DeployQA
    displayName: "Run tests & deploy — QA"
    environment: qa
    strategy:
      runOnce:
        deploy:
          steps:
          - task: NodeTool@0
            inputs: { versionSpec: '18.x' }
          - script: npm install -g newman newman-reporter-htmlextra
          - script: |
              set -e
              mkdir -p newman
              ENV_FILE="env/qa.postman_environment.json"
              [ -f "${ENV_FILE}" ] || { echo "Missing ${ENV_FILE}"; exit 3; }
              newman run collections/weatherstack.postman_collection.json \
                --environment "${ENV_FILE}" \
                --env-var access_key="$(WEATHERSTACK_KEY)" \
                --env-var api_key="$(QA_API_KEY)" \
                --reporters cli,htmlextra,junit \
                --reporter-htmlextra-export "newman/qa-report.html" \
                --reporter-junit-export "newman/qa-results.xml"
            env:
              WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
              QA_API_KEY: $(QA_API_KEY)
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'newman/qa-results.xml'
              testRunTitle: 'WeatherStack API — QA'
            condition: always()
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'newman'
              ArtifactName: 'NewmanReports'
              publishLocation: 'Container'
            condition: always()

# -------------------------
# UAT (independent)
# -------------------------
- stage: UAT
  displayName: "UAT"
  dependsOn: []             # independent
  jobs:
  - deployment: DeployUAT
    displayName: "Run tests & deploy — UAT"
    environment: uat
    strategy:
      runOnce:
        deploy:
          steps:
          - task: NodeTool@0
            inputs: { versionSpec: '18.x' }
          - script: npm install -g newman newman-reporter-htmlextra
          - script: |
              set -e
              mkdir -p newman
              ENV_FILE="env/uat.postman_environment.json"
              [ -f "${ENV_FILE}" ] || { echo "Missing ${ENV_FILE}"; exit 3; }
              newman run collections/weatherstack.postman_collection.json \
                --environment "${ENV_FILE}" \
                --env-var access_key="$(WEATHERSTACK_KEY)" \
                --env-var api_key="$(UAT_API_KEY)" \
                --reporters cli,htmlextra,junit \
                --reporter-htmlextra-export "newman/uat-report.html" \
                --reporter-junit-export "newman/uat-results.xml"
            env:
              WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
              UAT_API_KEY: $(UAT_API_KEY)
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'newman/uat-results.xml'
              testRunTitle: 'WeatherStack API — UAT'
            condition: always()
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'newman'
              ArtifactName: 'NewmanReports'
              publishLocation: 'Container'
            condition: always()

# -------------------------
# Prod (independent)
# -------------------------
- stage: Prod
  displayName: "Prod"
  dependsOn: []             # independent
  jobs:
  - deployment: DeployProd
    displayName: "Deploy — Prod"
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "Deploying to Production..."
            displayName: 'Deploy (Prod)'
