
# azure-pipelines.yml
trigger: none   # manual runs; change to - main if you also want CI

pool:
  vmImage: 'ubuntu-latest'

# Single secure variable group for all envs
variables:
- group: WeatherStackSecrets
# Expected secrets (in the variable group):
# POSTMAN_API_KEY, COLLECTION_UID
# DEV_ENV_UID, QA_ENV_UID, UAT_ENV_UID, PROD_ENV_UID
# WEATHERSTACK_KEY
# DEV_API_KEY, QA_API_KEY, UAT_API_KEY, PROD_API_KEY
# BASE_URL_DEV, BASE_URL_QA, BASE_URL_UAT, BASE_URL_PROD (optional overrides)

stages:
# =========================
# DEV (independent)
# =========================
- stage: DEV
  displayName: "DEV"
  dependsOn: []
  jobs:
  - job: Dev_FetchAndValidate
    displayName: "DEV: Fetch Latest & Validate API"
    steps:
    - checkout: none

    - script: sudo apt-get update && sudo apt-get install -y jq
      displayName: "Install jq"

    - script: |
        set -e
        mkdir -p collections env

        echo "Downloading latest Postman collection (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/collections/$(COLLECTION_UID)" \
          | jq -r '.collection' > collections/weatherstack.postman_collection.json

        echo "Downloading latest DEV environment (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/environments/$(DEV_ENV_UID)" \
          | jq -r '.environment' > env/dev.postman_environment.json

        # Optional: override base_url at runtime if you prefer
        if [ -n "$(BASE_URL_DEV)" ]; then
          jq '.values |= map(if .key=="base_url" then .value="$(BASE_URL_DEV)" else . end)' \
            env/dev.postman_environment.json > env/dev.tmp && mv env/dev.tmp env/dev.postman_environment.json
        fi

        ls -la collections env
      displayName: "Fetch latest collection & DEV environment"

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: "Install Node.js 18.x"

    - script: npm install -g newman newman-reporter-htmlextra
      displayName: "Install Newman & reporters"

    - script: |
        # Create report folder
        mkdir -p newman

        # Run newman but always continue to write/upload summary
        set +e
        newman run collections/weatherstack.postman_collection.json \
          --environment env/dev.postman_environment.json \
          --env-var access_key="$(WEATHERSTACK_KEY)" \
          --env-var api_key="$(DEV_API_KEY)" \
          --reporters cli,htmlextra,junit \
          --reporter-htmlextra-export "newman/dev-report.html" \
          --reporter-junit-export "newman/dev-results.xml"
        NEWMAN_EXIT=$?
        set -e

        {
          echo "# Weather API Tests — DEV"
          echo ""
          echo "Exit code: ${NEWMAN_EXIT}"
          echo "- JUnit: newman/dev-results.xml"
          echo "- HTML: newman/dev-report.html"
        } > newman/dev-summary.md

        SUMMARY_PATH="$(pwd)/newman/dev-summary.md"
        echo "##vso[task.uploadsummary]$SUMMARY_PATH"

        # Exit with newman's code so the job reflects pass/fail
        exit $NEWMAN_EXIT
      displayName: "Execute API validation (DEV)"
      env:
        POSTMAN_API_KEY: $(POSTMAN_API_KEY)
        WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
        DEV_API_KEY: $(DEV_API_KEY)
        BASE_URL_DEV: $(BASE_URL_DEV)

    - task: PublishTestResults@2
      displayName: "Publish DEV test results"
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'newman/dev-results.xml'
        testRunTitle: 'Weather API — DEV'

    - task: PublishBuildArtifacts@1
      displayName: "Publish DEV HTML report"
      condition: always()
      inputs:
        PathtoPublish: 'newman'
        ArtifactName: 'NewmanReports'
        publishLocation: 'Container'

# =========================
# QA (independent)
# =========================
- stage: QA
  displayName: "QA"
  dependsOn: []
  jobs:
  - job: QA_FetchAndValidate
    displayName: "QA: Fetch Latest & Validate API"
    steps:
    - checkout: none

    - script: sudo apt-get update && sudo apt-get install -y jq
      displayName: "Install jq"

    - script: |
        set -e
        mkdir -p collections env

        echo "Downloading latest Postman collection (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/collections/$(COLLECTION_UID)" \
          | jq -r '.collection' > collections/weatherstack.postman_collection.json

        echo "Downloading latest QA environment (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/environments/$(QA_ENV_UID)" \
          | jq -r '.environment' > env/qa.postman_environment.json

        if [ -n "$(BASE_URL_QA)" ]; then
          jq '.values |= map(if .key=="base_url" then .value="$(BASE_URL_QA)" else . end)' \
            env/qa.postman_environment.json > env/qa.tmp && mv env/qa.tmp env/qa.postman_environment.json
        fi

        ls -la collections env
      displayName: "Fetch latest collection & QA environment"

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: "Install Node.js 18.x"

    - script: npm install -g newman newman-reporter-htmlextra
      displayName: "Install Newman & reporters"

    - script: |
        mkdir -p newman

        set +e
        newman run collections/weatherstack.postman_collection.json \
          --environment env/qa.postman_environment.json \
          --env-var access_key="$(WEATHERSTACK_KEY)" \
          --env-var api_key="$(QA_API_KEY)" \
          --reporters cli,htmlextra,junit \
          --reporter-htmlextra-export "newman/qa-report.html" \
          --reporter-junit-export "newman/qa-results.xml"
        NEWMAN_EXIT=$?
        set -e

        {
          echo "# Weather API Tests — QA"
          echo ""
          echo "Exit code: ${NEWMAN_EXIT}"
          echo "- JUnit: newman/qa-results.xml"
          echo "- HTML: newman/qa-report.html"
        } > newman/qa-summary.md

        SUMMARY_PATH="$(pwd)/newman/qa-summary.md"
        echo "##vso[task.uploadsummary]$SUMMARY_PATH"

        exit $NEWMAN_EXIT
      displayName: "Execute API validation (QA)"
      env:
        POSTMAN_API_KEY: $(POSTMAN_API_KEY)
        WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
        QA_API_KEY: $(QA_API_KEY)
        BASE_URL_QA: $(BASE_URL_QA)

    - task: PublishTestResults@2
      displayName: "Publish QA test results"
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'newman/qa-results.xml'
        testRunTitle: 'Weather API — QA'

    - task: PublishBuildArtifacts@1
      displayName: "Publish QA HTML report"
      condition: always()
      inputs:
        PathtoPublish: 'newman'
        ArtifactName: 'NewmanReports'
        publishLocation: 'Container'

# =========================
# UAT (independent)
# =========================
- stage: UAT
  displayName: "UAT"
  dependsOn: []
  jobs:
  - job: UAT_FetchAndValidate
    displayName: "UAT: Fetch Latest & Validate API"
    steps:
    - checkout: none

    - script: sudo apt-get update && sudo apt-get install -y jq
      displayName: "Install jq"

    - script: |
        set -e
        mkdir -p collections env

        echo "Downloading latest Postman collection (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/collections/$(COLLECTION_UID)" \
          | jq -r '.collection' > collections/weatherstack.postman_collection.json

        echo "Downloading latest UAT environment (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/environments/$(UAT_ENV_UID)" \
          | jq -r '.environment' > env/uat.postman_environment.json

        if [ -n "$(BASE_URL_UAT)" ]; then
          jq '.values |= map(if .key=="base_url" then .value="$(BASE_URL_UAT)" else . end)' \
            env/uat.postman_environment.json > env/uat.tmp && mv env/uat.tmp env/uat.postman_environment.json
        fi

        ls -la collections env
      displayName: "Fetch latest collection & UAT environment"

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: "Install Node.js 18.x"

    - script: npm install -g newman newman-reporter-htmlextra
      displayName: "Install Newman & reporters"

    - script: |
        mkdir -p newman

        set +e
        newman run collections/weatherstack.postman_collection.json \
          --environment env/uat.postman_environment.json \
          --env-var access_key="$(WEATHERSTACK_KEY)" \
          --env-var api_key="$(UAT_API_KEY)" \
          --reporters cli,htmlextra,junit \
          --reporter-htmlextra-export "newman/uat-report.html" \
          --reporter-junit-export "newman/uat-results.xml"
        NEWMAN_EXIT=$?
        set -e

        {
          echo "# Weather API Tests — UAT"
          echo ""
          echo "Exit code: ${NEWMAN_EXIT}"
          echo "- JUnit: newman/uat-results.xml"
          echo "- HTML: newman/uat-report.html"
        } > newman/uat-summary.md

        SUMMARY_PATH="$(pwd)/newman/uat-summary.md"
        echo "##vso[task.uploadsummary]$SUMMARY_PATH"

        exit $NEWMAN_EXIT
      displayName: "Execute API validation (UAT)"
      env:
        POSTMAN_API_KEY: $(POSTMAN_API_KEY)
        WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
        UAT_API_KEY: $(UAT_API_KEY)
        BASE_URL_UAT: $(BASE_URL_UAT)

    - task: PublishTestResults@2
      displayName: "Publish UAT test results"
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'newman/uat-results.xml'
        testRunTitle: 'Weather API — UAT'

    - task: PublishBuildArtifacts@1
      displayName: "Publish UAT HTML report"
      condition: always()
      inputs:
        PathtoPublish: 'newman'
        ArtifactName: 'NewmanReports'
        publishLocation: 'Container'

# =========================
# PROD (independent)
# =========================
- stage: PROD
  displayName: "PROD"
  dependsOn: []
  jobs:
  - job: Prod_FetchAndValidate
    displayName: "PROD: Fetch Latest & Validate API"
    steps:
    - checkout: none

    - script: sudo apt-get update && sudo apt-get install -y jq
      displayName: "Install jq"

    - script: |
        set -e
        mkdir -p collections env

        echo "Downloading latest Postman collection (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/collections/$(COLLECTION_UID)" \
          | jq -r '.collection' > collections/weatherstack.postman_collection.json

        echo "Downloading latest PROD environment (secure header)..."
        curl --fail --silent --show-error \
          --header "X-Api-Key: $(POSTMAN_API_KEY)" \
          "https://api.getpostman.com/environments/$(PROD_ENV_UID)" \
          | jq -r '.environment' > env/prod.postman_environment.json

        if [ -n "$(BASE_URL_PROD)" ]; then
          jq '.values |= map(if .key=="base_url" then .value="$(BASE_URL_PROD)" else . end)' \
            env/prod.postman_environment.json > env/prod.tmp && mv env/prod.tmp env/prod.postman_environment.json
        fi

        ls -la collections env
      displayName: "Fetch latest collection & PROD environment"

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: "Install Node.js 18.x"

    - script: npm install -g newman newman-reporter-htmlextra
      displayName: "Install Newman & reporters"

    - script: |
        mkdir -p newman

        set +e
        newman run collections/weatherstack.postman_collection.json \
          --environment env/prod.postman_environment.json \
          --env-var access_key="$(WEATHERSTACK_KEY)" \
          --env-var api_key="$(PROD_API_KEY)" \
          --reporters cli,htmlextra,junit \
          --reporter-htmlextra-export "newman/prod-report.html" \
          --reporter-junit-export "newman/prod-results.xml"
        NEWMAN_EXIT=$?
        set -e

        {
          echo "# Weather API Tests — PROD"
          echo ""
          echo "Exit code: ${NEWMAN_EXIT}"
          echo "- JUnit: newman/prod-results.xml"
          echo "- HTML: newman/prod-report.html"
        } > newman/prod-summary.md

        SUMMARY_PATH="$(pwd)/newman/prod-summary.md"
        echo "##vso[task.uploadsummary]$SUMMARY_PATH"

        exit $NEWMAN_EXIT
      displayName: "Execute API validation (PROD)"
      env:
        POSTMAN_API_KEY: $(POSTMAN_API_KEY)
        WEATHERSTACK_KEY: $(WEATHERSTACK_KEY)
        PROD_API_KEY: $(PROD_API_KEY)
        BASE_URL_PROD: $(BASE_URL_PROD)

    - task: PublishTestResults@2
      displayName: "Publish PROD test results"
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'newman/prod-results.xml'
        testRunTitle: 'Weather API — PROD'

    - task: PublishBuildArtifacts@1
      displayName: "Publish PROD HTML report"
      condition: always()
      inputs:
        PathtoPublish: 'newman'
        ArtifactName: 'NewmanReports'
        publishLocation: 'Container'
